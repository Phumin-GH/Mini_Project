<?php
session_start();
if (!isset($_SESSION['email'])) {
    header("Location:login.php");
    exit();
}
?>
<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattaya Local Gems - ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÉ‡∏ô‡∏û‡∏±‡∏ó‡∏¢‡∏≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

    <header
        class="bg-primary text-white text-center p-4 shadow-sm d-flex justify-content-center align-items-center position-relative">
        <div>
            <h1>üíé Pattaya Local Gems</h1>
            <p class="lead mb-0">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏±‡∏ó‡∏¢‡∏≤</p>
        </div>
        <button class="btn btn-danger position-absolute top-0 end-0 m-3" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </header>
    <main class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" id="search-input" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à...">
            </div>
            <div class="col-md-4">
                <select id="category-filter" class="form-select">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                    <option value="restaurants">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                    <option value="cafe">‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</option>
                    <option value="tourist">‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                    <option value="bagery">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà</option>
                    <option value="fast_food">‡∏ü‡∏≤‡∏™‡∏ï‡πå‡∏ü‡∏π‡πâ‡∏î</option>
                    <option value="street_food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á</option>
                    <option value="souvenirs">‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î</button>
            </div>
        </div>
        <div class="flex-full" style="min-width: 280px;">
            <div id="map" class="w-100 rounded-3 mt-2" style="height: 660px;"></div>
        </div>
        <!-- <div id="business-grid" class="row g-4">
        </div> -->
    </main>

    <footer class="text-center p-3 mt-5 bg-light">
        <p>&copy; 2025 Pattaya Local Gems</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
    $(document).ready(function() {
        $('#logout-btn').on('click', function() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                $.ajax({
                    url: '../controls/logout.php',
                    type: 'POST',
                    dataType: 'JSON',
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '../index.php';
                        }
                    },
                    error(xhr, status, error) {
                        console.error('Error :' + error);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
                    }
                });
            }
        });
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        function loadBusinesses(category = '', searchTerm = '') {
            $.ajax({
                url: 'api/get_locations.php.php', // ‡πÑ‡∏ü‡∏•‡πå PHP ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                type: 'GET',
                dataType: 'json',
                data: {
                    category: category,
                    search: searchTerm
                },
                beforeSend: function() {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î (Loading Spinner)
                    $('#business-grid').html(
                        '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'
                    );
                },
                success: function(data) {
                    $('#business-grid').empty(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

                    if (data.length > 0) {
                        $.each(data, function(index, business) {
                            const businessCard = `
                                <div class="col-md-4">
                                    <div class="card h-100 business-card shadow-sm">
                                        <img src="${business.image}" class="card-img-top" alt="${business.name}">
                                        <div class="card-body">
                                            <h5 class="card-title">${business.name}</h5>
                                            <p class="card-text text-muted">${business.description}</p>
                                            <span class="badge bg-primary">${business.category}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#business-grid').append(businessCard);
                        });
                    } else {
                        $('#business-grid').html(
                            '<div class="col-12 text-center"><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p></div>'
                        );
                    }
                },
                error: function(xhr, status, error) {
                    console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error);
                    $('#business-grid').html(
                        '<div class="col-12 text-center alert alert-danger"><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p></div>'
                    );
                }
            });
        }
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
        let searchTimeout;
        $('#search-input').on('keyup', function() {
            clearTimeout(searchTimeout);
            const searchTerm = $(this).val();
            const category = $('#category-filter').val();
            searchTimeout = setTimeout(function() {
                loadBusinesses(category, searchTerm);
            }, 500);
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
        $('#category-filter').on('change', function() {
            const category = $(this).val();
            const searchTerm = $('#search-input').val();
            loadBusinesses(category, searchTerm);
        });
        loadBusinesses();

    });
    // mapboxgl.accessToken = '<?php /*echo $_ENV['MapBox_key']*/ ?>';

    // const map = new mapboxgl.Map({
    //     container: 'map',
    //     style: 'mapbox://styles/mapbox/streets-v11',
    //     center: [100.523186, 13.736717], // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
    //     zoom: 5
    // });

    // // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö Marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡πÉ‡∏ä‡πâ id ‡πÄ‡∏õ‡πá‡∏ô key
    // let markers = {};

    function loadAllMarkers() {
        $.ajax({
            url: 'get_locations.php',
            type: 'GET',
            dataType: 'json',
            success: function(locations) {
                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                locations.forEach(addMarker);
            },
            error: function(error) {
                console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏î‡πâ:", error);
            }
        });
    }
    loadAllMarkers();
    const lat =
        <?php echo isset($house['Property_latitude']) ? floatval($house['Property_latitude']) : 13.7563; ?>;
    const lng =
        <?php echo isset($house['Property_longitude']) ? floatval($house['Property_longitude']) : 100.5018; ?>;
    const map = L.map('map').setView([lat, lng], 20);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
    </script>

</body>

</html>